options:
  env:
    KUBECONFIG: ./kubeconfig/config
    NAMESPACE: kubestone
    IO_DEPTH: '1 8 16'

steps:
- id: start-pods
  uses: docker://bitnami/kubectl:1.17.4
  runs: [bash, -euc]
  args:
  - |
    kubectl create -n "$NAMESPACE" -f ./ceph_benchmarks/deployment.yml

- id: copy-config
  uses: docker://bitnami/kubectl:1.17.4
  runs: [./ceph_benchmarks/copy_config.sh]

- id: run-benchmarks
  uses: docker://bitnami/kubectl:1.17.4
  runs: [./ceph_benchmarks/run_benchmarks.sh]

- id: plot-results
  uses: docker://czentye/matplotlib-minimal:3.1.2
  runs: [sh, -euc]
  args:
  - |
    python ./ceph_benchmarks/plot_osd_benchmarks.py
    python ./ceph_benchmarks/plot_rados_benchmarks.py

- id: teardown-pods
  uses: docker://bitnami/kubectl:1.17.4
  runs: [bash, -euc]
  args:
  - |
    kubectl delete -n "$NAMESPACE" -f ./ceph_benchmarks/deployment.yml
