options:
  env:
    KUBECONFIG: ./kubeconfig/config

steps:
- id: bootstrap-config
  uses: docker://biowdl/pyyaml:3.13-py37-slim
  runs: [python]
  args: ['./kubestone-fio/bootstrap.py']

- id: start-pods
  uses: docker://bitnami/kubectl:1.17.4
  runs: [bash, -euc]
  args:
  - |
    kubectl create -n kubestone -f ./kubestone-fio/pv.yaml
    kubectl create -n kubestone -f ./kubestone-fio/pvc.yaml
    kubectl create -n kubestone -f ./kubestone-fio/job.yaml

- id: run-tests
  uses: docker://bitnami/kubectl:1.17.4
  runs: [./kubestone-fio/run-tests.sh]
  env:
    BLOCKDEVICES: sda sdb

- id: download-results
  uses: docker://bitnami/kubectl:1.17.4
  runs: [./kubestone-fio/download-results.sh]

- id: plot-results
  uses: docker://czentye/matplotlib-minimal:3.1.2
  runs: [python]
  args: [./kubestone-fio/plot.py]

- id: teardown-pods
  uses: docker://bitnami/kubectl:1.17.4
  runs: [bash, -euc]
  args:
  - |
    kubectl delete -n kubestone -f ./kubestone-fio/job.yaml
    kubectl delete -n kubestone -f ./kubestone-fio/pvc.yaml
    kubectl delete -n kubestone -f ./kubestone-fio/pv.yaml
