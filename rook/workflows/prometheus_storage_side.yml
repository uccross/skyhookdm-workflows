options:
  env:
    KUBECONFIG: ./kubeconfig/config

steps:
- id: setup
  uses: docker://bitnami/kubectl:1.17.4
  runs: [bash, -euc]
  args:
  - |
    kubectl apply -f https://raw.githubusercontent.com/coreos/prometheus-operator/master/bundle.yaml
    kubectl apply -f ./prometheus_storage_side/service-monitor.yaml
    kubectl apply -f ./prometheus_storage_side/prometheus.yaml
    kubectl apply -f ./prometheus_storage_side/prometheus-service.yaml
    echo "http://$(kubectl -n rook-ceph -o jsonpath={.status.hostIP} get pod prometheus-rook-prometheus-0):30900"

- id: teardown
  uses: docker://bitnami/kubectl:1.17.4
  runs: [bash, -euc]
  args:
  - |
    kubectl delete --ignore-not-found -f ./prometheus_storage_side/service-monitor.yaml
    kubectl delete --ignore-not-found -f ./prometheus_storage_side/prometheus.yaml
    kubectl delete --ignore-not-found -f ./prometheus_storage_side/prometheus-service.yaml
    kubectl delete --ignore-not-found -f https://raw.githubusercontent.com/coreos/prometheus-operator/master/bundle.yaml
