options:
    env:
        KUBECONFIG: ./kubeconfig/config

steps:
- id: start
  uses: docker://bitnami/kubectl:1.17.4
  args: [create, -f, ./run-query/job.yml]

- id: copy-config
  uses: docker://bitnami/kubectl:1.17.4
  runs: [bash, -euc]
  args:
  - |
    POD=$(kubectl get pod -l app=run-query -o jsonpath="{.items[0].metadata.name}")
    kubectl cp ./ceph-client/config/ceph.conf default/$POD:/etc/ceph/ceph.conf
    kubectl cp ./ceph-client/config/keyring default/$POD:/etc/ceph/keyring

- id: run-queries
  uses: docker://bitnami/kubectl:1.17.4
  runs: [bash, -euc]
  args:
  - |
    POD=$(kubectl get pod -l app=run-query -o jsonpath="{.items[0].metadata.name}")
    SCRIPT=$(cat ./run-query/entrypoint.sh)
    kubectl exec $POD -- bash -c "$SCRIPT"

- id: teardown
  uses: docker://bitnami/kubectl:1.17.4
  args: [delete, -f, ./run-query/job.yml]
